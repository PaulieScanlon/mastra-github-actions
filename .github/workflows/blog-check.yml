name: Blog Post Check

on:
  pull_request:
    paths:
      - "src/app/blog/posts/**"
  workflow_dispatch:
    inputs:
      file:
        description: "Blog post file to check"
        required: true
        type: string

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

permissions:
  contents: read
  pull-requests: write

jobs:
  manual-check:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
      - run: npm ci
      - name: Check blog post
        run: npx tsx .github/scripts/check-blog.ts "${{ inputs.file }}"

  pr-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"

      - run: npm ci

      - name: Get changed blog files
        id: changed-files
        run: |
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- 'src/app/blog/posts/*.mdx' | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Check blog posts
        id: check
        if: steps.changed-files.outputs.files != ''
        run: |
          RESULTS=""
          HAS_ISSUES=false
          for file in ${{ steps.changed-files.outputs.files }}; do
            echo "Checking $file..."
            OUTPUT=$(npx tsx .github/scripts/check-blog.ts "$file" 2>&1) || true
            if [[ "$OUTPUT" != *"No issues found"* ]]; then
              HAS_ISSUES=true
              RESULTS="$RESULTS\n\n## $file\n\n$OUTPUT"
            fi
          done
          echo "has_issues=$HAS_ISSUES" >> $GITHUB_OUTPUT
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: steps.changed-files.outputs.files != ''
        uses: actions/github-script@v7
        env:
          RESULTS: ${{ steps.check.outputs.results }}
          HAS_ISSUES: ${{ steps.check.outputs.has_issues }}
        with:
          script: |
            const identifier = '<!-- blog-check: style-review -->';
            const hasIssues = process.env.HAS_ISSUES === 'true';

            try {
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const existingComment = comments.find(comment => comment.body.includes(identifier));

              if (hasIssues) {
                const logsUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
                const body = [
                  identifier,
                  '## üìù Blog Style Review',
                  '',
                  process.env.RESULTS,
                  '',
                  `üìã [View workflow logs](${logsUrl})`
                ].join('\n');

                if (existingComment) {
                  await github.rest.issues.updateComment({
                    comment_id: existingComment.id,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: body
                  });
                } else {
                  await github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: body
                  });
                }
              } else if (existingComment) {
                // Delete the comment when all issues are resolved
                await github.rest.issues.deleteComment({
                  comment_id: existingComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                });
              }
            } catch (error) {
              console.error('Failed to manage comment:', error);
            }
